-- ============================================
-- UPDATE AUTO-ARCHIVE TIME
-- تحديث وقت الأرشفة التلقائية من 00:00 إلى 23:59
-- التاريخ: 4 ديسمبر 2024
-- ============================================

-- ============================================
-- الهدف:
-- تغيير وقت الأرشفة التلقائية إلى 23:59 (قبل نهاية اليوم بدقيقة)
-- الأرشفة تتم في نفس اليوم (archive_date = CURRENT_DATE)
-- ============================================

-- Step 1: Remove old cron job
SELECT cron.unschedule('daily-patient-archive');

-- Step 2: Schedule new cron job at 23:59
SELECT cron.schedule(
  'daily-patient-archive',
  '59 23 * * *',  -- Every day at 23:59
  $$SELECT archive_all_patients()$$
);

-- Step 3: Verify the new schedule
SELECT 
  jobname,
  schedule,
  command,
  active
FROM cron.job 
WHERE jobname = 'daily-patient-archive';

-- ============================================
-- ملاحظات:
-- ============================================

-- 1. الوقت:
--    '59 23 * * *' يعني الساعة 23:59 كل يوم
--    (دقيقة 59، ساعة 23، كل يوم، كل شهر، كل يوم من الأسبوع)

-- 2. التاريخ:
--    archive_date = CURRENT_DATE يعني نفس اليوم
--    مثال: 4 ديسمبر الساعة 23:59 → archive_date = 2024-12-04

-- 3. النتيجة:
--    - في نهاية كل يوم (23:59)، يتم أرشفة جميع المرضى
--    - التايم لاين يصبح نظيف ومستعد لليوم التالي
--    - المرضى المؤرشفين يظهرون في صفحة الأرشيف

-- 4. المنطقة الزمنية:
--    Supabase يستخدم UTC افتراضياً
--    إذا كنت في منطقة زمنية مختلفة، قد تحتاج تعديل الوقت

-- ============================================
-- اختبار يدوي (اختياري):
-- ============================================

-- لتشغيل الأرشفة يدوياً:
-- SELECT archive_all_patients();

-- للتحقق من المرضى المؤرشفين:
-- SELECT * FROM patients WHERE archive_date IS NOT NULL ORDER BY archive_date DESC;

-- للتحقق من المرضى النشطين:
-- SELECT * FROM patients WHERE archive_date IS NULL;

-- ============================================
-- END
-- ============================================

# ููุฒุฉ ุงูุฃุฑุดูุฉ ูููุฏูุฑ ุงูุนุงู

## ๐ ุงูุชุงุฑูุฎ: 13 ููููุจุฑ 2024

---

## ๐ฏ **ุงููุฏู:**

ุฅุถุงูุฉ ุฒุฑ ุฃุฑุดูุฉ ูููุฏูุฑ ุงูุนุงู ูููู ุฌููุน ูุฑุถู ุงููุฑูุฒ ุงูุญุงูู ุฅูู ุงูุฃุฑุดูู ูุน ุนุฒู ูุงูู ุจูู ุงููุฑุงูุฒ.

---

## โ **ุงูููุฒุงุช ุงููููุฐุฉ:**

### **1. ุฒุฑ ุงูุฃุฑุดูุฉ ูู Header**

**ุงููููุน:** ุฑุฃุณ ุงูุตูุญุฉ (Header) - ุนูู ุงููููู

**ุงูุธููุฑ:** ูููุฏูุฑ ุงูุนุงู (`super_admin`) ููุท

**ุงูููุฏ (`App.tsx` - ุณุทุฑ 749-771):**
```typescript
{/* โ ุฒุฑ ุงูุฃุฑุดูุฉ - ูุธูุฑ ูููุฏูุฑ ุงูุนุงู ููุท */}
{user?.role === 'super_admin' && selectedClinicId !== null ? (
  <TouchableOpacity 
    style={styles.iconButton}
    onPress={() => {
      Alert.alert(
        'ุฃุฑุดูุฉ',
        `ูู ุชุฑูุฏ ุฃุฑุดูุฉ ุฌููุน ูุฑุถู ${selectedClinicName}?`,
        [
          { text: 'ุฅูุบุงุก', style: 'cancel' },
          { 
            text: 'ุฃุฑุดูุฉ', 
            onPress: handleArchive
          }
        ]
      );
    }}
  >
    <Ionicons name="archive-outline" size={28} color="#6B7280" />
  </TouchableOpacity>
) : (
  <View style={{ width: 44 }} />
)}
```

---

### **2. ุฏุงูุฉ handleArchive**

**ุงููุธููุฉ:** ููู ุฌููุน ูุฑุถู ุงููุฑูุฒ ุงูุญุงูู ุฅูู ุงูุฃุฑุดูู

**ุงูููุฏ (`App.tsx` - ุณุทุฑ 425-461):**
```typescript
const handleArchive = async () => {
  try {
    const clinicId = selectedClinicId || userClinicId;
    
    if (clinicId === null) {
      Alert.alert('ุฎุทุฃ', 'ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ูุฑูุฒ ุฃููุงู');
      return;
    }

    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    
    console.log('[Archive] Archiving patients for clinic:', clinicId, 'date:', today);
    
    // โ ุชุญุฏูุซ archive_date ูุฌููุน ุงููุฑุถู ูู ุงููุฑูุฒ ุงูุญุงูู
    const { data, error } = await supabase
      .from('patients')
      .update({ 
        archive_date: today,
        status: 'complete'
      })
      .eq('clinic_id', clinicId) // โ ุนุฒู ุญุณุจ ุงููุฑูุฒ
      .is('archive_date', null); // ููุท ุงููุฑุถู ุบูุฑ ุงููุคุฑุดููู
    
    if (error) throw error;
    
    // โ ุฅุนุงุฏุฉ ุชุญููู ุงููุฑุถู (ุณูููู ูุงุฑุบุงู)
    await loadPatients();
    
    Alert.alert('ูุฌุญ', `ุชูุช ุฃุฑุดูุฉ ุฌููุน ูุฑุถู ${selectedClinicName} ุจูุฌุงุญ`);
  } catch (error: any) {
    console.error('[Archive] Error:', error);
    Alert.alert('ุฎุทุฃ', error.message || 'ูุดูุช ุงูุฃุฑุดูุฉ');
  }
};
```

**ุงูุฎุทูุงุช:**
1. ุงูุชุญูู ูู ูุฌูุฏ `clinic_id`
2. ุญุณุงุจ ุชุงุฑูุฎ ุงูููู (`YYYY-MM-DD`)
3. ุชุญุฏูุซ `archive_date` ู `status` ูุฌููุน ุงููุฑุถู ูู ุงููุฑูุฒ
4. ุชุตููุฉ ุญุณุจ `clinic_id` (ุนุฒู ูุงูู)
5. ููุท ุงููุฑุถู ุบูุฑ ุงููุคุฑุดููู (`archive_date IS NULL`)
6. ุฅุนุงุฏุฉ ุชุญููู ุงููุฑุถู (Timeline ูุงุฑุบ)
7. ุนุฑุถ ุฑุณุงูุฉ ูุฌุงุญ

---

### **3. ุฅุตูุงุญ ุนุฒู ุงูุฃุฑุดูู**

**ุงููุดููุฉ:** `ArchiveScreen.tsx` ูุงู ูุณุชุฎุฏู `userClinicId` ููุท

**ุงูุญู:** ุงุณุชุฎุฏุงู `selectedClinicId || userClinicId`

**ุงูุชุนุฏููุงุช ูู `ArchiveScreen.tsx`:**

#### **ุฃ. ูู `loadArchivedPatients()` (ุณุทุฑ 82-83):**
```typescript
// โ ุงุณุชุฎุฏุงู selectedClinicId ุฃููุงู (ูููุฏูุฑ ุงูุนุงู)ุ ุซู userClinicId
const clinicId = selectedClinicId || userClinicId;
```

#### **ุจ. ูู `loadStatistics()` (ุณุทุฑ 147-148):**
```typescript
// โ ุงุณุชุฎุฏุงู selectedClinicId ุฃููุงู (ูููุฏูุฑ ุงูุนุงู)ุ ุซู userClinicId
const clinicId = selectedClinicId || userClinicId;
```

---

## ๐งช **ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ:**

### **ุงูุณููุงุฑูู 1: ุฃุฑุดูุฉ ูุฑูุฒ ูุดุฑู**
1. ุชุณุฌูู ุฏุฎูู ูู General Manager
2. ุงุฎุชูุงุฑ ูุฑูุฒ ูุดุฑู
3. ุฅุถุงูุฉ 3 ูุฑุถู (ูุดุฑู1ุ ูุดุฑู2ุ ูุดุฑู3)
4. ุงูุถุบุท ุนูู ุฒุฑ "ุฃุฑุดูุฉ"
5. ุชุฃููุฏ ุงูุฃุฑุดูุฉ
6. โ **ุงููุชูุฌุฉ:** Timeline ูุงุฑุบ
7. ูุชุญ ุตูุญุฉ ุงูุฃุฑุดูู
8. โ **ุงููุชูุฌุฉ:** ูุธูุฑ 3 ูุฑุถู ูุคุฑุดููู

### **ุงูุณููุงุฑูู 2: ุนุฒู ุงูุฃุฑุดูู ุจูู ุงููุฑุงูุฒ**
1. ุชุณุฌูู ุฏุฎูู ูู General Manager
2. ุงุฎุชูุงุฑ ูุฑูุฒ ูุดุฑู โ ุฅุถุงูุฉ ูุฑูุถ "ูุดุฑู" โ ุฃุฑุดูุฉ
3. ุงุฎุชูุงุฑ ูุฑูุฒ ุญุทูู โ ุฅุถุงูุฉ ูุฑูุถ "ุญุทูู" โ ุฃุฑุดูุฉ
4. ูุชุญ ุงูุฃุฑุดูู ูู ูุฑูุฒ ูุดุฑู
5. โ **ุงููุชูุฌุฉ:** ูุธูุฑ "ูุดุฑู" ููุท (ูููุณ "ุญุทูู")
6. ูุชุญ ุงูุฃุฑุดูู ูู ูุฑูุฒ ุญุทูู
7. โ **ุงููุชูุฌุฉ:** ูุธูุฑ "ุญุทูู" ููุท (ูููุณ "ูุดุฑู")

### **ุงูุณููุงุฑูู 3: ุงูุฃุฑุดูุฉ ูุง ุชุคุซุฑ ุนูู ูุฑุงูุฒ ุฃุฎุฑู**
1. ุชุณุฌูู ุฏุฎูู ูู General Manager
2. ุงุฎุชูุงุฑ ูุฑูุฒ ูุดุฑู โ ุฅุถุงูุฉ 2 ูุฑูุถ
3. ุงุฎุชูุงุฑ ูุฑูุฒ ุญุทูู โ ุฅุถุงูุฉ 2 ูุฑูุถ
4. ุงูุนูุฏุฉ ููุฑูุฒ ูุดุฑู โ ุฃุฑุดูุฉ
5. โ **ุงููุชูุฌุฉ:** Timeline ูุดุฑู ูุงุฑุบ
6. ุงุฎุชูุงุฑ ูุฑูุฒ ุญุทูู
7. โ **ุงููุชูุฌุฉ:** Timeline ุญุทูู ูุง ูุฒุงู ูุญุชูู ุนูู 2 ูุฑูุถ (ูู ูุชุฃุซุฑ)

---

## ๐ **ุตูุญุฉ ุงูุฃุฑุดูู:**

**ุงูููู:** `ArchiveScreen.tsx` (55 KB)

**ุงูุชุจููุจุงุช:**
1. **ุงูุฃุฑุดูู:** ุนุฑุถ ุฌููุน ุงููุฑุถู ุงููุคุฑุดููู ูุน Timeline ูุงูู
2. **ุงูุฅุญุตุงุฆูุงุช:** ุนุฏุฏ ุงููุฑุถู ุญุณุจ Condition, Treatment, Clinic

**ุงูุนุฒู:**
- โ ูู ูุฑูุฒ ูู ุฃุฑุดูู ูููุตู
- โ ุงููุฏูุฑ ุงูุนุงู ูุฑู ุฃุฑุดูู ุงููุฑูุฒ ุงููุฎุชุงุฑ ููุท
- โ Doctor/Team Leader ูุฑูู ุฃุฑุดูู ูุฑูุฒูู ููุท

---

## ๐ฎ **ุงููุณุชูุจู: ุงูุฃุฑุดูุฉ ุงูุชููุงุฆูุฉ**

**ุงููุทููุจ:**
- ุฃุฑุดูุฉ ุชููุงุฆูุฉ ูู ููู ุงูุณุงุนุฉ 10:00 ุตุจุงุญุงู
- ูุฌููุน ุงููุฑุงูุฒ

**ุงูููู ุงูููุฌูุฏ:** `supabase_auto_archive_final.sql`

**ุงูุชูููุฐ:** (ุณูุชู ูุงุญูุงู)
```sql
-- Function to archive all patients
CREATE OR REPLACE FUNCTION auto_archive_patients()
RETURNS void AS $$
BEGIN
  UPDATE patients
  SET archive_date = CURRENT_DATE
  WHERE archive_date IS NULL;
END;
$$ LANGUAGE plpgsql;

-- Schedule: Run daily at 10:00 AM
-- (ูุญุชุงุฌ ุฅุนุฏุงุฏ pg_cron ุฃู cron job ุฎุงุฑุฌู)
```

---

## ๐ **ุงููููุงุช ุงููุนุฏูุฉ:**

1. **`App.tsx`**
   - ุฅุถุงูุฉ ุฒุฑ ุงูุฃุฑุดูุฉ ูู Header (ุณุทุฑ 749-771)
   - ุฅุถุงูุฉ ุฏุงูุฉ `handleArchive()` (ุณุทุฑ 425-461)

2. **`ArchiveScreen.tsx`**
   - ุฅุตูุงุญ `loadArchivedPatients()` (ุณุทุฑ 82-83)
   - ุฅุตูุงุญ `loadStatistics()` (ุณุทุฑ 147-148)

3. **`TODO.md`**
   - ุชุญุฏูุซ ุงูุญุงูุฉ

---

## ๐ **ููููุฉ ุงูุงุณุชุฎุฏุงู:**

### **ูููุฏูุฑ ุงูุนุงู:**
1. ุณุฌู ุฏุฎูู ูู General Manager
2. ุงุฎุชุฑ ูุฑูุฒ ูู ุงููุงุฆูุฉ
3. ุงูุชุญ Timeline
4. ุงุถุบุท ุนูู ุฃููููุฉ ุงูุฃุฑุดูู (๐ฆ) ูู ุงูุฑุฃุณ (ุนูู ุงููููู)
5. ุฃูุฏ ุงูุฃุฑุดูุฉ
6. โ Timeline ุณูุตุจุญ ูุงุฑุบุงู
7. ุงูุชุญ ุตูุญุฉ ุงูุฃุฑุดูู ูุฑุคูุฉ ุงููุฑุถู ุงููุคุฑุดููู

### **ููุฃุฏูุงุฑ ุงูุฃุฎุฑู:**
- ุฒุฑ ุงูุฃุฑุดูุฉ **ูุง ูุธูุฑ** ูู Doctor, Team Leader, Coordinator
- ูููููู ููุท **ุนุฑุถ** ุงูุฃุฑุดูู (ุฅุฐุง ูุงูุช ูุฏููู ุงูุตูุงุญูุฉ)

---

**ุชู ุงูุชูููุฐ ุจูุฌุงุญ! โ**
